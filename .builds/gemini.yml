image: alpine/edge
oauth: pages.sr.ht/PAGES:RW
packages:
  - py3-pip
  - hut
  - yq
tasks:
  - tools: |
      pip3 install md2gemini --break-system-packages
      find ~/.local -name 'renderers.py' -exec sed -i -E 's/text\.rstrip\(\)\.endswith\("\[" \+ str\(self\.footnote_num\) \+ "\]"\)/False/' {} \;
  - generate: |
      cd xdavidwu.link/_posts
      for i in $(ls -r *.md);do
        OIFS="$IFS"
        IFS=$'\n'
        mv "$i" "${i}.orig"
        set +x
        while read LINE; do
          F=$(echo "$LINE" | sed 's/^{% include_relative \(.*\) %}$/\1/')
          if [ -f "$F" ]; then
            cat "$F" >> "$i"
          else
            printf "%s\n" "$LINE" >> "$i"
          fi
        done < "${i}.orig"
        set -x
        IFS=$OIFS
        echo "=> $(echo $i | sed s/\.md$/.gmi/) $(echo $i | cut -f 1-3 -d '-'): $(grep '^title:' $i | yq .title)" >> ../gemini/index.gmi
      done
      ~/.local/bin/md2gemini -w -d ../gemini -a -f -i tab -l paragraph *.md
  - publish: |
      hut pages publish xdavidwu.link/gemini -d xdavidwu.link -p GEMINI
